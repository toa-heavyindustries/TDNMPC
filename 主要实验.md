好的！下面给你一套“可直接落地”的、尽量只用 pandapower 内置网络 / 数据 的实验设计。内容包含：选用的网络、耦合方式、器件型号与参数（变压器、储能、并联电容、限值等）、控制/时间尺度、求解器与日志输出、以及可复现实验步骤。你拿去就能按方案写代码实现（符合你给的 Python 编程要求）。

⸻

一、网络与耦合（输配协同）

1) 传输网（TSO）
	•	采用 pandapower.networks.case118()（PYPOWER 来源的 IEEE 118 节点系统，内置数据齐全） ￼
	•	用作上层（输电层）优化与潮流的母网。

2) 配电网（DSO）

优先用 pandapower 内置的、带 DER 的中压/低压典型网：
	•	CIGRE MV（含全部 DER）：create_cigre_network_mv(with_der="all")（含 8 个 PV、1 台风机、2 套电池、2 燃料电池、1 柴油 CHP、1 CHP 燃料电池；15 个 sgen，共 18 个负荷、2 台变压器、15 条线） ￼
	•	IEEE European LV（不对称三相）：ieee_european_lv_asymmetric(scenario=...)（0.416 kV、1 台 0.8 MVA 变压器、906 个低压母线；自带 on/off-peak 三种负荷/发电缩放场景） ￼
	•	备选中压真实拓扑：mv_oberrhein()（20 kV、两台 25 MVA 的 HV/MV 站、141 个 MV/LV 站、6 个 MV 负荷；默认作为放射式运行） ￼

建议主线实验用 CIGRE MV (with_der="all") + IEEE European LV，保证 DER/场景数据“拿来即用”，同时可切换 mv_oberrhein 做鲁棒性对比。

3) 输配耦合（把 DSO 嵌入 TSO）
	•	在 case118 里“挑 3 个负荷最大的母线作为耦合点”（代码里自动筛选 top-3 负荷母线），将其各自的负荷替换为一台 HV/MV 标准型变压器 + DSO 网络 的连接。
	•	连接方法：
	1.	用 pandapower.toolbox.merge_nets(net_tso, net_dso) 把网表拼到一起（索引自动去冲突，可校验合并前后潮流一致性） ￼
	2.	在耦合母线旁新建一个 110 kV 辅助母线，接入 2 绕组变压器至 DSO 的 20 kV 汇集母线（或 LV 模型的 MV/LV 变电站上游侧）。
	3.	变压器 采用内置标准型（见下一节），无需手填等值电路，pandapower 会根据标准型参数自动建模 ￼。

⸻

二、器件“型号/参数”一览（可直接编码）

1) HV/MV 变压器（TSO–DSO 接口）

直接用 标准型库（std_types）中的现成型号，示例两档可选（额定 Tap 见库表）：
	•	25 MVA 110/20 kV：vk%=12.0，vkr%=0.41，pfe=14 kW，i0%=0.07，tap_side=“hv”，tap_step%=1.5，tap_min=-9，tap_max=+9。
	•	40 MVA 110/20 kV：vk%=16.2，vkr%=0.34，pfe=18 kW，i0%=0.05，tap 同上。
（均为 pandapower 文档的 内置标准型号 条目） ￼

选型建议：若某耦合点 DSO 峰值交换功率 > 20 MW，则用 40 MVA 型；否则 25 MVA 型足够。

2) 配电侧调压与无功
	•	有载调压：每台接口变压器挂 离散分接控制器 DiscreteTapControl，电压带宽建议 [0.99, 1.01] pu（控制侧=LV/MV 侧），容忍 tol=0.005，并启用“tap hunting 抑制”以防振荡（pandapower 已集成） ￼
	•	并联电容：在 DSO 的两个电压偏低或功率因数差的母线处各加一组 阶梯式电容：
	•	create_shunt_as_capacitor(bus=..., q_mvar=2.0, loss_factor=0.005)，max_step=3（每步 2 Mvar，合计 0–6 Mvar） ￼

3) 储能（BESS）
	•	元素：用 pandapower 的 storage 元素（原生支持功率/能量边界、SoC、P/Q 上下界，适配 OPF/控制器） ￼
	•	布点：在 CIGRE MV 中，选择 2–3 个靠近分布式光伏聚集的母线各放 1 套；在 IEEE LV 中选 1 个支路末端放 1 套（末端压降敏感）。
	•	单套 BESS 典型参数（建议）
	•	额定功率：P_rating = 5 MW（MV）/ 0.5 MW（LV）
	•	额定能量：E_max = 10 MWh（MV）/ 1 MWh（LV）
	•	max_p_mw = +P_rating，min_p_mw = -P_rating（充正放负，或按你代码习惯）
	•	充/放效率（DC-DC）按 92%（RT：~85–95% 文献区间，取中值），在能量更新里等效成 η_c=η_d=√0.92 ≈ 0.959；SoC 约束 [10%, 90%]（行业常用窗口以延寿） ￼
	•	无功能力：|Q| ≤ 0.8 * P_rating（逆变器留余度；可用控制器限幅）
	•	在网表里用：

pp.create_storage(net, bus=..., p_mw=0.0, max_e_mwh=10.0, min_e_mwh=1.0,
                  soc_percent=50.0, max_p_mw=5.0, min_p_mw=-5.0,
                  max_q_mvar=4.0, min_q_mvar=-4.0, controllable=True)

（字段与示例见文档） ￼

4) 电压/潮流/热稳约束（统一基准）
	•	电压运行带：规划/调度内建议 0.95–1.05 pu（较 EN 50160 的 ±10% 更收敛，常见研究取 0.95–1.05 pu） ￼
	•	标准 EN 50160 信息（供说明书引用）：公共配电系统允许电压在名义值±10% 范围（统计意义上）；快速电压变化 LV 5%、MV 4% 的典型目标值。本实验仍采用更严格 0.95–1.05 pu 作为MPC硬约束/软约束带。 ￼
	•	线路载流率：用内置 loading_percent 计算，限制 ≤ 100%（必要时 95% 预警）。
	•	变压器负载：限制 ≤ 100% 额定。

⸻

三、时间尺度与数据（尽量用内置）

1) 快照与场景
	•	LV 三相网络 直接利用 ieee_european_lv_asymmetric 的 scenario（"on_mid" / "off_start" / "off_end"），可作为 3 个代表性时段 的快照仿真。 ￼

2) 时序（日内 24 h）
	•	若需要连续 24 h：用 timeseries 模块 + DFData + ConstControl 给 load / sgen / storage 的 p_mw（或 scaling）喂入曲线；输出结果用 OutputWriter（xlsx/csv/pkl 任意）。文档与教程明确了 DFData/ConstControl/OutputWriter 的用法。
	•	数据源：DFData(profiles_df)；控制器：

ConstControl(net, element='load', element_index=net.load.index,
             variable='scaling', data_source=ds, profile_name=net.load.index)


	•	参考：DataSource/DFData、Timeseries Example 文档与教程。 ￼

说明：pandapower 本身不内置真实 24h 逐点曲线，但其 timeseries 机制支持我们用“合成/缩放”方式快速得到可复现实验曲线（代码生成，不依赖外部文件），同时 LV 网络自带 on/off-peak 场景 可作为 3 点快照基线。

⸻

四、两层分布式 TI-NMPC 的“可编码”配置

1) 时间离散与滚动
	•	采样间隔 Δt = 15 min；MPC 预测域 N = 12（=3 小时），滚动 96 步覆盖 24 h。
	•	传输层（TSO）步长与配电层一致；耦合处每步迭代 2–3 次（见下）。

2) 上层（TSO）子问题（基于 case118）
	•	目标：机组有功成本 + 线路/电压罚函数 + 与 DSO 交换功率 (P,Q) 的跟踪/惩罚。
	•	约束：发电机 P/Q、母线电压、线流、耦合点注入 (P,Q) ∈ DSO 给出的 TI 包络。
	•	实现：
	•	快速法：用 runopp（PYPOWER OPF）做每步近似 OPF，再叠加二次罚项实现跟踪；
	•	或用 pyomo/casadi + IPOPT 编 MPC，潮流方程可用 DC 近似（输电）或以牛拉雅可微近似/敏感度线性化。

3) 下层（DSO）子问题（基于 CIGRE MV / IEEE LV）
	•	目标：电压保持 + 网损 + 开关/分接代价 + 尽量跟踪上层给的 (P*, Q*)；储能 SoC 终端惩罚回到中位。
	•	约束：配电网潮流（runpp 或线性近似）、电压/电流/设备边界、BESS SoC/功率/无功、并联电容离散步位。
	•	TI 包络生成（Trajectory-Independent Envelope）：
	•	离线/在线用 灵敏度扫描：围绕当前点在耦合口做多组 (ΔP, ΔQ) 扰动，调用 pandapower 计算电压/线荷是否合规，收集可行点并 凸包化 得到 (P,Q) 多边形（也可细化为分段 P-Q-dP/dt-E 超集）——这是“包络”的数值构造，不依赖单一轨迹。
	•	包络边界再加 安全边际（例如把 0.95–1.05 pu 收紧到 0.96–1.04 pu）。
	•	控制器联动：
	•	DiscreteTapControl 维持 0.99–1.01 pu， hunting_limit=3；
	•	电容步进：根据母线无功/电压阈值简单启停（可自写 Controller）。 ￼

4) 交互与迭代（每个 MPC 步）
	•	DSO 给 TSO ：(P,Q) 凸包（多边形顶点）+ ΔP 限制（如 ±2 MW/步）+（可选）等效损耗/电压灵敏度。
	•	TSO 在凸包内优化得到 (P\*, Q\*)；
	•	DSO 以 (P\*, Q\*) 为参考解本地 NMPC，使配电侧可行且最优；若不可行，缩小包络重发（最多 2 次）；
	•	固定耦合功率后，联合 runpp(run_control=True) 验证潮流可行，落地控制量（tap/电容步/储能功率）。

⸻

五、关键数值与限值（建议默认）

项	数值（建议）	依据 / 说明
母线电压约束	0.95–1.05 pu	研究/运行常用窗口（相对 EN50160 ±10% 更严格） ￼
LV 场景	"on_mid"/"off_start"/"off_end"	内置场景，用于快照或校准时序缩放 ￼
BESS RT 效率	0.92（DC-DC），η_c=η_d≈0.959	文献综述 85–95% 区间内取中值 ￼
BESS SoC 窗口	10%–90%	工程常用寿命窗口（行业资料与实践趋势） ￼
接口变压器	25 MVA 或 40 MVA 110/20 kV（std_types）	直接用内置型号表，无需手算等值 ￼
Tap 控制带	0.99–1.01 pu，步长按 std_types(1.5%/步)	离散分接控制器参数建议 ￼
电容步进	步长 2 Mvar，最多 3 步	create_shunt_as_capacitor 支持阶梯步位 ￼
线路/变压器	loading ≤ 100%	用 res_line.loading_percent / res_trafo.loading_percent 监控


⸻

六、求解与日志
	•	潮流：pp.runpp(net, numba=True)，控制器联动 run_control=True。
	•	时序：timeseries.run_timeseries + OutputWriter（存 res_bus.vm_pu、res_line.loading_percent、接口 P/Q、储能 p_mw/SoC）。教程给了典型 log_variable 用法。 ￼
	•	OPF/优化：
	•	轻量：pp.runopp + 罚项；
	•	全 NMPC：casadi + ipopt（推荐 tol=1e-6，max_iter=200），以 pandapower 线性化/代理模型作为约束近似（每步可数值更新雅可比）。

⸻

七、可复现实验清单（建议按序执行）
	1.	基线快照
	•	case118 单独潮流；CIGRE MV(with_der="all")、ieee_european_lv_asymmetric("on_mid") 单独潮流与电压合规检查。 ￼
	2.	耦合搭建
	•	自动选 case118 负荷 Top-3 母线，插入 25/40 MVA 110/20 kV 变压器并 merge_nets 连接至两个 DSO 网；校验合并前后潮流一致。 ￼
	3.	装置与控制
	•	在 DSO 指定母线放置 BESS（参数如上），配置 DiscreteTapControl & 电容阶梯控制。 ￼
	4.	三场景快照（LV on_mid/off_start/off_end）
	•	记录全网电压/载流、接口功率、BESS 状态，作为 NMPC 目标的基准点。 ￼
	5.	24h 时序（无协同）
	•	用合成曲线驱动负荷/PV（DFData + ConstControl），无协同控制，仅本地 tap+电容+BESS；记指标（越限时长、网损、弃光等）。 ￼
	6.	24h TI-NMPC 协同
	•	按“上层 OPF / 下层 NMPC / 包络迭代”流程滚动 96 步，比较指标提升（越限减少、网损/弃光降低、储能循环深度、接口计划跟踪）。
	7.	对比与灵敏度
	•	变更：接口变压器容量（25↔40 MVA）、BESS 容量（±50%）、电压边带（0.96–1.04 ↔ 0.95–1.05）、tap 带宽（±1% ↔ ±2%），复现鲁棒性。

⸻

八、你写代码时可直接引用的 API/文档要点
	•	CIGRE 网络加载与 with_der 参数（HV/MV/LV、含 PV/Wind/All-der）：文档明确函数与元素数量。 ￼
	•	IEEE European LV 三相网络与场景：函数名与三个 scenario 选项。 ￼
	•	MV Oberrhein 概况（可做对比网）：两台 25 MVA 站、20 kV、141 个 MV/LV 站等。 ￼
	•	标准型库（变压器/线路）：直接用内置“25/40/63 MVA 110/20 kV”等型号。 ￼
	•	网络合并：pandapower.toolbox.merge_nets。 ￼
	•	时序/数据源/控制器/输出：DFData、ConstControl、OutputWriter 与示例。 ￼
	•	离散分接控制 与 tap-hunting 抑制：预置控制器文档/论文。 ￼
	•	并联电容与步进：create_shunt_as_capacitor。 ￼
	•	储能元素字段：create_storage 参数/示例。 ￼

⸻
