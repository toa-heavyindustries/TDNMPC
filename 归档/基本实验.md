

# 一、数据与时间轴（对应 M1：`src/io/profiles.py`）

**目标**：生成/加载 24h 典型日的负荷、PV、温度曲线；定义滚动窗口（5min 步长）与预测/控制时域。

1. **时间轴设定**

* 基准步长 Δt = 5 min；一天 288 点。
* 预测步长 `N_pred` ∈ {24, 48, 72}（对应2h/4h/6h预测窗），控制步长 `N_ctrl` ≤ `N_pred`，推荐 `N_ctrl=12`（1h 控制窗）。
* 预测滚动：每个仿真步推进 1 个 Δt，调用一次 NMPC。

2. **曲线生成/加载**

* 若有公共数据接入则读取；若无则按典型形状随机化：

  * 负荷：基线为早晚峰双峰曲线 + 加性日内噪声（高斯+低频正弦），按节点负荷份额分摊。
  * PV：正弦穹顶+云遮蔽噪声（随机块状衰减）。
  * 温度：日周期正弦+缓慢漂移（用于温控负荷或效率修正）。
* 输出：`data/loads.csv`, `data/pv.csv`, `data/temp.csv`（列含 `time,index,...`）。

3. **不确定性与预测误差场景**

* 在 `data/scenarios.yaml` 定义多组误差等级与相关性：

  * 负荷预测相对误差 σ\_L ∈ {2%, 5%, 10%}
  * PV 预测相对误差 σ\_PV ∈ {5%, 15%, 30%}
  * 误差相关性：时序 AR(1) 系数 ρ ∈ {0.3, 0.6}
* 在 `profiles.py` 内提供 `sample_forecast(truth, σ, ρ, horizon)` 生成滚动预测。

**验收**：运行 `profiles.py` 的函数 `make_profiles(seed)`：

* 画出 24h 负荷/PV/温度曲线（保存至 `results/figs/`）
* 校验对齐（时间索引严格等间隔，起止为 00:00–24:00）

---

# 二、配网模型与灵敏度（对应 M2：`src/dso/network.py`）

**目标**：搭建 IEEE-33 与 IEEE-123 模型；提取/校准 LinDistFlow 或局部线性化灵敏度。

1. **网模构建**

* 使用 `pandapower` 载入案例或手动构建（电压标幺、支路阻抗、变压器、可控设备接入点）。
* 保存 AC 模型：`nets/ieee33.net.pkl`, `nets/ieee123.net.pkl`

2. **灵敏度提取**

* 两种方式二选一或并做对照：

  * **LinDistFlow**：直流近似扩展（含 R/X），得到 `ΔV ≈ S · [ΔP; ΔQ]`。
  * **局部线性化**：在当前工作点对 AC 潮流做雅可比近似，定期/每步更新。
* 在 `network.py` 提供：

  * `solve_ac(net)`：AC 潮流
  * `get_sensitivity(net, method="lindistflow"|"local", at_state)`：返回电压对注入功率的灵敏度矩阵 S。

3. **灵敏度校准实验**

* 随机采样 K 组 (Δp,Δq)（例如 K=100），对若干节点施加小扰动：

  * 用线性化预测 `ΔV_lin = S[Δp;Δq]`
  * 与 AC 潮流求得的 `ΔV_ac` 对比
* 指标：`L2` 和 `max-abs` 误差；目标 < 2–3%（可随网型/节点数略放宽）
* 结果落盘：`results/runs/<ts>/sensitivity_eval.csv` + 误差直方图

---

# 三、控制问题与算法（`src/control/`）

## 3.1 NMPC 基底（`nmpc.py`，Pyomo+Ipopt）

**模型元素**（统一接口，便于双层/分布式封装）：

* 状态：各节点电压偏差、储能 SOC、开关位等（可选）。
* 决策：有功/无功功率调度（含 PV 可限发/逆变无功）、储能充放电功率、分接头/电容器动作（若纳入）。
* 目标（可加权求和或层次化）：

  * 供电成本/损耗最小
  * 电压偏差/越限惩罚
  * 可再生弃电惩罚
  * 动作稀疏/平滑（开关/储能寿命）
* 约束：

  * 物理：功率平衡、线路潮流（用线性化或锥近似）、电压上下限、储能 SOC & P 限、爬坡约束
  * 设备：逆变器 S 限、功率因数/无功窗
  * 运行：N\_ctrl 内动作、N\_pred 内预测

**求解器**：Ipopt（带 warm start）；必要时切换 Bonmin/HiGHS 处理混合变量（把开关变量做松弛或分层处理）。

## 3.2 TI 包络驱动模块（`ti_envelope.py`）

* 功能：对滚动预测产生的多场景轨迹，构造**轨迹无关（TI）包络**约束/鲁棒管束：

  * 在预测窗对各时刻、各节点的功率注入/电压范围构建上/下界（包络），并在 NMPC 模型中施加（或通过罚项实现），以减少场景爆炸。
* 消融：关闭 TI（仅单场景或样本均值）、开启 TI（多场景包络）、全场景鲁棒（基线对照）。

## 3.3 双层分布式协调（`bilevel.py`）

* 上层（输电侧/DSO 之间协调器）：价格/信号/耦合边界（PCC 功率、无功、电压边界）迭代更新。
* 下层（DSO 层）：各自解 NMPC（带本地约束与 TI 包络）。
* 通信/分布式求解：ADMM/价格协调/可行域交换三选一（建议从**价格协调**起步）。
* 终止准则：边界功率不平衡 < ε，迭代步数上限 K\_max，或目标收敛。

---

# 四、对比基线与实验矩阵

## 4.1 基线方法

* **B0**：无协调+本地贪心（电压越限再校正）
* **B1**：集中式 NMPC（全网一体、无分布式）
* **B2**：分布式 NMPC（无 TI 包络，仅单场景预测）
* **B3**：鲁棒全场景 NMPC（多场景硬约束，计算较慢）
* **Our**：分布式 NMPC + **TI 包络**

## 4.2 实验因子

* 网络规模：IEEE-33 / IEEE-123
* 预测误差等级：σ\_L × σ\_PV ∈ {2,5,10}% × {5,15,30}%
* 相关性：ρ ∈ {0.3, 0.6}
* 通信与实时性：每步通信次数 K ∈ {1,3,5}；单步时间预算 T\_budget ∈ {1s, 2s, 5s}
* 灵敏度模型：LinDistFlow / 局部线性化（在线更新间隔 τ ∈ {每步，每6步}）
* TI 包络：开/关；包络紧度系数 α ∈ {0.8, 0.9, 1.0}

**全因子会很大**，建议采用拉丁超立方抽样从组合空间抽取 20–30 组“代表性设置”。

---

# 五、仿真运行器与流程（`src/sim/runner.py`）

伪代码流程（统一接口，便于复现实验）：

1. 读取配置 `config.json`（或 CLI 参数）→ 固定 `seed`
2. 加载 `net.pkl` → 初始化工作点（AC 潮流）
3. 读入真实曲线与滚动预测生成器
4. 对 t = 0…287：

   * 生成/更新预测（N\_pred）
   * 获取/更新灵敏度 S（按 τ 策略）
   * 调用算法（B0/B1/B2/B3/Our）
   * 应用第一步控制量 → 更新系统状态（可回写到 pandapower/仿真器）
   * 记录：电压、潮流、动作、可再生弃电、迭代、时间开销
5. 保存运行产物（见第七节）

---

# 六、评估指标与可视化（`src/eval/metrics.py`）

**主指标**

* **安全性**：电压越限次数/时长/幅度（95/99 分位）、线路过载率
* **经济性**：网络损耗（kWh）、可再生弃电量、购电成本/等价费用
* **可控性**：动作总变动量（储能充放电循环、开关/分接头动作次数）
* **鲁棒性**：在多场景误差下的最差/分位性能
* **收敛与实时性**：单步求解时间、总求解时间、分布式迭代次数、失败率
* **可扩展性**：33→123 节点性能退化斜率（时间、越限）

**可视化**

* 24h 电压热图（节点×时间）
* PCC 功率轨迹对比（真实 vs 预测 vs 包络）
* 误差箱线图（不同 σ、ρ）
* 计算时间堆叠柱状图（建模、求解、通信）
* 帕累托散点（损耗 vs 越限惩罚；不同方法上色）

---

# 七、可重复性与产物落盘

每次运行创建：`results/runs/<YYYYmmdd_HHMMSS>/`

* `config.json`：完整参数、随机种子、方法标签
* `logs.csv`：逐步纪录（t、P/Q 动作、电压、越限标记、求解时间、迭代数…）
* `trace.parquet`：高频时序（便于 pandas/大数据分析）
* `figs/`：关键图表（统一命名规则）
* `summary.md`：自动生成的摘要，列出核心指标表格与一图总览

---

# 八、关键超参数与默认值（可在 `config.json` 中修改）

```json
{
  "seed": 20250920,
  "dt_min": 5,
  "N_pred": 48,
  "N_ctrl": 12,
  "net": "ieee33",
  "sensitivity": {"method": "lindistflow", "update_every": 6},
  "forecast": {"sigma_load": 0.05, "sigma_pv": 0.15, "rho": 0.6},
  "ti_envelope": {"enabled": true, "alpha": 0.9, "scenario_count": 8},
  "dist_opt": {"scheme": "price", "max_iters": 3, "tol": 1e-3},
  "solver": {"name": "ipopt", "max_iter": 300, "tol": 1e-6, "warm_start": true},
  "time_budget_s": 2.0
}
```

---

# 九、实验用例（建议先跑这 6 组做“冒烟测试”）

1. **Sanity-33-Deterministic**：ieee33，σ=0%，TI关，集中式 NMPC（B1）
2. **LinCheck-33**：ieee33，小扰动灵敏度校验（K=100）
3. **Our-33-Moderate**：ieee33，σ\_L=5%，σ\_PV=15%，ρ=0.6，TI开，分布式（K=3）
4. **Baseline-B2-33**：同3，但 TI关（B2）
5. **Our-123-Moderate**：ieee123，同3
6. **Our-33-RealtimeTight**：同3，但 `time_budget_s=1.0`，观察实时可行性

---

# 十、预期结论与论文支撑点（与指标挂钩）

* 在**中高预测误差**下，Our（分布式+TI）相较 B2/B3：

  * **越限次数**与**弃电量**显著下降（统计显著，p<0.05）
  * **单步时间**接近 B2、远低于 B3（鲁棒全场景）
  * **可扩展性**好：33→123 节点退化斜率更低
* 灵敏度模型的**在线更新**能显著降低电压误差与不必要动作
* 在**严格时间预算**下，Our 仍可满足实时性（>95% 步满足预算）

---

# 十一、命令行与一键复现（建议）

* `python -m src.io.profiles --seed 20250920`
* `python -m src.dso.network --case ieee33 --save nets/ieee33.net.pkl`
* `python -m src.sim.runner --config configs/our_33.json`
* `python -m src.eval.metrics --run results/runs/<ts>/ --make-all-figs`

---

# 十二、常见陷阱与兜底

* **Ipopt不收敛**：缩放变量、放宽容差、暖启动、分解约束或缩小 `N_pred`
* **电压越限顽固**：增大包络紧度 α、提高电压惩罚、增加无功/储能容量上限（合理范围）
* **分布式震荡**：减小价格步长或 ADMM ρ、增加 `max_iters`
* **实时性不足**：启发式初值、减少场景数、灵敏度更新每 6 步一次

---

