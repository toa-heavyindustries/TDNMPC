太棒了！系统能跑起来后，建议按“由内到外、先静后动”的顺序调试。下面是一条龙的最小必经路径（每一步都有明确产出和判定标准），照着做你会很快把闭环跑稳。

# 0) 固定环境与配置（一次性）

* 固定随机种子、求解器与步长：5 min 步长、预测窗 N=12。
* 写 `configs/default.yaml`（网络文件、接口母线、负荷/PV/温度、求解器选项、约束裕度σ等）。
* 打开结构化日志：`logs/{ts}/runner.log` + `metrics.csv`（方便回放）。

# 1) 基准潮流体检（TSO/DSO 各自独立）

**目标**：确认内置网络参数健康、潮流可解、边界电压安全。
**做法**：

* `pp.runpp(net_tso)`, `pp.runpp(net_dso)`；记录 `res_bus.vm_pu`、`res_line.loading_percent`。
* **判定**：`vm_pu ∈ [0.95, 1.05]`、线载流率 < 100%、无孤岛/开路。
  **常见坑**：电压上下限默认值不一致 → 统一成 \[0.95, 1.05]。

# 2) T–D 接口适配器（聚合 P/Q）

**目标**：把 DSO 作为“可控聚合负荷”挂在 TSO 指定母线。
**做法**：

* 写 `src/interface/adapter.py`：函数

  * `measure_boundary(net_dso) -> (P,Q,V)`（取变压器高压侧注入为正）
  * `apply_reference(net_dso, Pref, Qref)`（把参考分解到储能/PV/无功设备，先写一个简单分配策略）
  * `replace_tso_load(net_tso, bus_id, P0, Q0)`（把原负荷替换为“DSO聚合点”）
* **单元测试**：把 `Pref` 从 −5→+5 MW 扫描；**期望** TSO 接口母线电压随 `Pref` 单调变化（符号合理）。

# 3) 配电侧线性化与灵敏度（LinDistFlow）

**目标**：得到 $ΔV \approx S_p ΔP + S_q ΔQ$ 的局部线性模型。
**做法**：

* 在当前工况周围做小扰动（如 ±0.5 MW、±0.5 MVAr），调用 AC 潮流得到电压变化，最小二乘估计 $S_p,S_q$。
* **判定（验收）**：随机 50 组 (ΔP,ΔQ)，线性预测与 AC 结果的母线电压 MAPE < 2–3%。
  **常见坑**：扰动太大导致非线性偏差 ↑ → 减小步长或分段线性化。

# 4) 最小可用“包络”v0（先用简单盒形）

**目标**：先跑通接口约束通路，再升级 TI 包络。
**做法**：

* 逐时构造每步的矩形可行域：$\underline P \le P_t \le \overline P$, $\underline Q(P_t)\le Q_t \le \overline Q(P_t)$（由设备额定与电压灵敏度给个保守界）。
* 若有储能，叠加**累计能量**约束：SoC 由最差效率界推进，得到 $\underline s \le s_0 + \sum(\eta_c u^+ - u^-/\eta_d - \bar \ell)\le \overline s$。
* 序列化成不等式，输出 `boundary.json`（给 TSO 用）。
  **判定**：Monte-Carlo 采样 200 条参考轨迹，落在盒内的都能被 DSO 单独跟踪，不出现越限。

# 5) 上层 OPF/NMPC 骨架（先 DC-OPF + 软约束）

**目标**：让 TSO 能“看见”包络并给出参考轨迹。
**做法**：

* `src/tso/opf.py`：先用 DC-OPF（线性潮流 + 线约束），把每个接口 (P,Q) 变量加上**包络不等式**。
* 目标函数：发电成本 + 电压/潮流软惩罚 + 边界跟踪平滑项（ΔP²）。
* **判定**：单窗优化能在 ≤1–2 s 收敛（小系统），输出的 (P,Q) 均在包络内。

# 6) 下层 DSO-NMPC 跟踪最小闭环

**目标**：闭环跑起来，看误差和电压。
**做法**：

* `src/dso/nmpc.py`：用二次型跟踪（OSQP）或 NLP（IPOPT），决策=储能 P、逆变器 Q；约束=功率限、SoC、近似电压线性约束。
* 滚动：每 5 min 收到 TSO 的 $P^{ref},Q^{ref}$，优化得到 $u_0$ 执行。
* **判定**：60 min 仿真中电压全在 \[0.95,1.05]、SoC 不越界、$\|P-P^{ref}\|_2/N$ 小于 2–5% 额定。

# 7) 端到端滚动仿真器

**目标**：把 1–6 串起来，一键跑完一天。
**做法**：

* `src/sim/runner.py`：循环 t=1…T

  1. 读取预测（负荷/PV）
  2. 调 TSO-OPF 得到各接口 $P^{ref},Q^{ref}$
  3. 各 DSO 执行 NMPC → 回写实际 (P,Q)、新状态
  4. 记录 KPI + 可视化（实时曲线）
* **判定（日志/KPI）**：

  * Voltage violations = 0
  * Line overloads = 0
  * Envelope violations = 0（TSO 解应天然满足）
  * 平均 TSO 求解时间 < 协调步长的 10–20%

# 8) 加入扰动与鲁棒收缩（tube）

**目标**：在预测误差下仍零越限。
**做法**：

* 给负荷/PV 注入 ±10–15% 高斯噪声 + 随机相位抖动。
* 在 TSO 侧对包络做“右端收紧”σ（等价 Minkowski 差），σ 按误差分布 95% 分位设。
* **判定**：扰动场景下 violations 仍为 0，跟踪误差均值小幅上升但受控。

# 9) 性能曲线与回归测试

**目标**：让结果“看得见、复现得了”。
**做法**：

* 绘图：电压热图、接口 P/Q 对比、SoC 曲线、TSO 求解时间箱线图、误差分布直方图。
* 写 `tests/`：

  * `test_sensitivity_accuracy.py`（线性化 MAPE < 3%）
  * `test_envelope_feasibility.py`（采样 100 轨迹全可行）
  * `test_closed_loop_violations.py`（滚动 24h 无越限）

# 10) 常见故障与快修

* **TSO 解不可行**：包络过紧 → 放宽电压裕度或减小 tube 收缩 σ。
* **DSO 跟踪抖动**：权重过大/过小 → 增大控制变化惩罚 R 或缩短预测窗 N。
* **线性化失真**：分段线性化或在线更新灵敏度（每 30 min 重估一次）。
* **求解慢**：把整数动作（投切电容/分段开关）先固定，等闭环稳了再加。

---
